{% extends 'base.html' %}

{% load format_extras %}

{% block title %}{{ event.title }} - {{ PLATFORM_NAME }}{% endblock %}

{% block content %}

{% if event.cover_photo_processing_status == 'pending' or event.cover_photo_processing_status == 'processing' %}
<section class="d-lg-none mb-4" aria-labelledby="mobile-cover-photo-heading">
  <h2 class="visually-hidden" id="mobile-cover-photo-heading">
    Event cover photo
  </h2>
  <div
    class="bg-secondary rounded d-flex align-items-center justify-content-center"
    style="width: 100%; height: 260px"
  >
    <div class="text-center" role="status" aria-live="polite">
      <div class="spinner-border text-white mb-2" role="status">
        <span class="visually-hidden">Processing...</span>
      </div>
    </div>
  </div>
</section>
{% elif event.cover_photo_avif_url or event.cover_photo_webp_url or event.cover_photo %}
<section class="d-lg-none mb-4" aria-labelledby="mobile-cover-photo-heading">
  <h2 class="visually-hidden" id="mobile-cover-photo-heading">
    Event cover photo
  </h2>
  <figure class="mb-0">
    <picture>
      {% if event.cover_photo_avif_url %}
      <source srcset="{{ event.cover_photo_avif_url }}" type="image/avif" />
      {% endif %}
      {% if event.cover_photo_webp_url %}
      <source srcset="{{ event.cover_photo_webp_url }}" type="image/webp" />
      {% endif %}
      {% if event.cover_photo_webp_url %}
      <img
        src="{{ event.cover_photo_webp_url }}"
        class="img-fluid rounded"
        alt="{{ event.title }}"
        style="width: 100%; max-height: 320px; object-fit: cover"
      />
      {% elif event.cover_photo %}
      <img
        src="{{ event.cover_photo.url }}"
        class="img-fluid rounded"
        alt="{{ event.title }}"
        style="width: 100%; max-height: 320px; object-fit: cover"
      />
      {% else %}
      <img
        src="{{ event.cover_photo_avif_url }}"
        class="img-fluid rounded"
        alt="{{ event.title }}"
        style="width: 100%; max-height: 320px; object-fit: cover"
      />
      {% endif %}
    </picture>
    <figcaption class="visually-hidden">
      Cover photo for {{ event.title }}
    </figcaption>
  </figure>
</section>
{% endif %}

<section>
  <article class="row g-4" aria-labelledby="event-title">
    <section class="col-lg-7" aria-label="Event overview">
      <div class="mb-4">
        <div
          class="d-flex flex-row align-items-center justify-content-between gap-3 mb-3"
        >
          <h1 class="h2 fw-bold mb-0 text-truncate" id="event-title">
            {{ event.title }}
          </h1>
          {% if is_organizer %}
          <div class="dropdown">
            <button
              class="btn btn-secondary d-inline-flex align-items-center justify-content-center"
              type="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
              aria-label="Organizer actions"
              style="width: 40px; height: 40px"
              title="Open organizer actions menu"
            >
              <i class="fa-solid fa-ellipsis" aria-hidden="true"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <a
                  class="dropdown-item d-flex justify-content-between align-items-center"
                  href="{% url 'edit_event' event.id %}"
                >
                  <span>Edit Event</span>
                  <i
                    class="fa-solid fa-pen-to-square ms-2"
                    aria-hidden="true"
                  ></i>
                </a>
              </li>
              <li>
                <form
                  method="post"
                  action="{% url 'delete_event' event.id %}"
                  class="m-0"
                >
                  {% csrf_token %}
                  <button
                    type="submit"
                    class="dropdown-item text-danger d-flex justify-content-between align-items-center w-100 border-0 bg-transparent text-start"
                    hx-on="click: if(!confirm('Are you sure you want to delete this event?')) { event.preventDefault(); }"
                    title="Delete this event"
                  >
                    <span>Delete Event</span>
                    <i class="fa-solid fa-trash ms-2" aria-hidden="true"></i>
                  </button>
                </form>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <a
                  class="dropdown-item d-flex justify-content-between align-items-center"
                  href="{% url 'send_text_blast' event.id %}"
                >
                  <span>Send Text Blast</span>
                  <i class="fa-solid fa-envelope ms-2" aria-hidden="true"></i>
                </a>
              </li>
              <li>
                <a
                  class="dropdown-item d-flex justify-content-between align-items-center"
                  href="{% url 'attendee_list' event.id %}"
                >
                  <span>View Attendees</span>
                  <i
                    class="fa-solid fa-people-group ms-2"
                    aria-hidden="true"
                  ></i>
                </a>
              </li>
              {% if can_invite %}
              <li>
                <a
                  class="dropdown-item d-flex justify-content-between align-items-center"
                  href="{% url 'invite_organizer' event.id %}"
                >
                  <span>Add Co-Organizer</span>
                  <i class="fa-solid fa-user-plus ms-2" aria-hidden="true"></i>
                </a>
              </li>
              {% endif %} {% if is_co_organizer %}
              <li><hr class="dropdown-divider" /></li>
              <li>
                <form
                  method="post"
                  action="{% url 'leave_event' event.id %}"
                  class="m-0"
                >
                  {% csrf_token %}
                  <button
                    type="submit"
                    class="dropdown-item text-warning d-flex justify-content-between align-items-center w-100 border-0 bg-transparent text-start"
                    hx-on="click: if(!confirm('Are you sure you want to leave the organizing team?')) { event.preventDefault(); }"
                    title="Leave the organizing team"
                  >
                    <span>Leave Event</span>
                    <i
                      class="fa-solid fa-right-from-bracket ms-2"
                      aria-hidden="true"
                    ></i>
                  </button>
                </form>
              </li>
              {% endif %}
            </ul>
          </div>
          {% endif %}
        </div>

        <div class="mb-3">
          {% include 'events/partials/event_meta_list.html' with event=event primary_organizer_name=primary_organizer_name additional_organizer_names=additional_organizer_names %}
          {% if event.description %}
          <div class="mt-1" aria-labelledby="event-description-heading">
            <h2 id="event-description-heading" class="visually-hidden">
              Event description
            </h2>
            <p class="text-muted mb-0" style="white-space: pre-line">
              {{ event.description }}
            </p>
          </div>
          {% endif %}
        </div>
        {% if not event.is_listed or not event.auto_reminders_enabled %}
        <div class="d-flex flex-wrap gap-2 mb-3">
          {% if not event.is_listed %}
          <span class="badge bg-secondary">Hidden from listings</span>
          {% endif %} {% if not event.auto_reminders_enabled %}
          <span class="badge bg-secondary">Reminders disabled</span>
          {% endif %}
        </div>
        {% endif %}
      </div>

      <div id="rsvp-mobile-container" class="rsvp-container">
        {% include 'events/partials/rsvp_form.html' with form_id='mobileRsvpForm' wrapper_classes='mb-4 d-lg-none' container_id='rsvp-mobile-container' %}
      </div>

      <section class="card mb-4" aria-labelledby="share-event-heading">
        <div class="card-body">
          <div class="d-none d-sm-block">
            <div class="position-relative mb-4">
              <h2 class="h4 fw-bold" id="share-event-heading">Share Event</h2>
              <div class="position-absolute top-0 end-0 d-flex gap-2">
                <button
                  onclick="copyShortUrl(event)"
                  class="btn btn-primary d-inline-flex align-items-center gap-2 flex-shrink-0"
                  title="Copy the shareable link"
                >
                  Copy Link
                  <i class="fa-solid fa-link text-white" aria-hidden="true"></i>
                </button>
                {% if is_organizer %}
                <a
                  href="{% url 'invite_to_event' event.id %}"
                  class="btn btn-primary d-inline-flex align-items-center justify-content-center gap-2 flex-shrink-0"
                  title="Invite People"
                >
                  <span>Invite</span>
                  <i
                    class="fa-solid fa-user-plus text-white"
                    aria-hidden="true"
                  ></i>
                </a>
                {% endif %}
              </div>
            </div>
            <div class="d-flex flex-row gap-2">
              <button
                onclick="showQRCode()"
                class="btn btn-secondary flex-fill d-inline-flex align-items-center justify-content-center gap-2"
                type="button"
                aria-controls="qrCodeModal"
                aria-haspopup="dialog"
                title="View the QR code"
              >
                <span>View QR Code</span>
                <i class="fa-solid fa-qrcode" aria-hidden="true"></i>
              </button>
              <a
                href="{% url 'export_ical' event.id %}"
                class="btn btn-secondary flex-fill d-inline-flex align-items-center justify-content-center gap-2"
              >
                <span>Download iCal</span>
                <i class="fa-brands fa-apple" aria-hidden="true"></i>
              </a>
              <a
                href="https://calendar.google.com/calendar/render?action=TEMPLATE&text={{ event.title|urlencode }}&dates={{ event.event_state_date|date:'Ymd\THis' }}/{% if event.event_end_date %}{{ event.event_end_date|date:'Ymd\THis' }}{% else %}{{ event.event_state_date|date:'Ymd\THis' }}{% endif %}&details={{ event.description|urlencode }}&location={{ event.location|urlencode }}"
                target="_blank"
                rel="noreferrer"
                class="btn btn-secondary flex-fill d-inline-flex align-items-center justify-content-center gap-2"
              >
                <span>Add to Google Calendar</span>
                <i class="fa-brands fa-google" aria-hidden="true"></i>
              </a>
            </div>
          </div>

          <div class="d-block d-sm-none">
            <h2 class="h4 fw-bold mb-3" id="share-event-heading">
              Share Event
            </h2>
            <div class="d-flex flex-column gap-2">
              <button
                onclick="copyShortUrl(event)"
                class="btn btn-primary d-inline-flex align-items-center justify-content-center gap-2"
                title="Copy the shareable link"
              >
                <span>Copy Link</span>
                <i class="fa-solid fa-link text-white" aria-hidden="true"></i>
              </button>
              {% if is_organizer %}
              <a
                href="{% url 'invite_to_event' event.id %}"
                class="btn btn-primary d-inline-flex align-items-center justify-content-center gap-2"
                title="Invite People"
              >
                <span>Invite</span>
                <i
                  class="fa-solid fa-user-plus text-white"
                  aria-hidden="true"
                ></i>
              </a>
              {% endif %}
              <button
                onclick="showQRCode()"
                class="btn btn-secondary d-inline-flex align-items-center justify-content-center gap-2"
                type="button"
                aria-controls="qrCodeModal"
                aria-haspopup="dialog"
                title="View the QR code"
              >
                <span>View QR Code</span>
                <i class="fa-solid fa-qrcode" aria-hidden="true"></i>
              </button>
              <a
                href="{% url 'export_ical' event.id %}"
                class="btn btn-secondary d-inline-flex align-items-center justify-content-center gap-2"
              >
                <span>Download iCal</span>
                <i class="fa-brands fa-apple" aria-hidden="true"></i>
              </a>
              <a
                href="https://calendar.google.com/calendar/render?action=TEMPLATE&text={{ event.title|urlencode }}&dates={{ event.event_state_date|date:'Ymd\THis' }}/{% if event.event_end_date %}{{ event.event_end_date|date:'Ymd\THis' }}{% else %}{{ event.event_state_date|date:'Ymd\THis' }}{% endif %}&details={{ event.description|urlencode }}&location={{ event.location|urlencode }}"
                target="_blank"
                rel="noreferrer"
                class="btn btn-secondary d-inline-flex align-items-center justify-content-center gap-2"
              >
                <span>Add to Google Calendar</span>
                <i class="fa-brands fa-google" aria-hidden="true"></i>
              </a>
            </div>
          </div>
        </div>
      </section>

      <section class="card mb-4" aria-labelledby="photo-album-heading">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <h2 class="h4 fw-bold" id="photo-album-heading">Photo Album</h2>
            {% if event.photo_album_url %}
            <button
              onclick="copyPhotoAlbumUrl(event)"
              class="btn btn-primary d-inline-flex align-items-center gap-2 flex-shrink-0"
              title="Copy the photo album link"
            >
              Copy Link
              <i class="fa-solid fa-link text-white" aria-hidden="true"></i>
            </button>
            {% endif %}
          </div>

          {% if event.photo_album_url %}
          <p class="text-muted mb-0">
            View and add photos using the photo album link.
          </p>
          {% else %}
          <p class="text-muted mb-0">
            The organizer hasn't shared a photo album link yet.
          </p>
          {% endif %}
        </div>
      </section>

      <section class="card mb-4" aria-labelledby="activity-heading">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="h4 fw-bold mb-0" id="activity-heading">Activity</h2>
          </div>

          {% if text_blasts %}
          <div class="d-flex flex-column gap-3">
            {% for blast in text_blasts %}
            <article class="border rounded-3 p-3 bg-body-secondary">
              <div
                class="d-flex justify-content-between flex-wrap gap-2 align-items-center mb-2"
              >
                <div class="d-flex align-items-center">
                  {% include 'partials/user_avatar.html' with size='sm' extra_classes='me-2 flex-shrink-0' label='Organizer avatar' %}
                  <div>
                    <p class="fw-semibold mb-0">
                      {% if blast.sent_by and blast.sent_by.name %}
                        {{ blast.sent_by.name }}
                      {% else %}
                        Organizer
                      {% endif %}
                    </p>
                    <small class="text-muted d-block">
                      {% format_datetime_conditional_tz blast.created_at event.timezone "F j, Y \\a\\t g:i A" %}
                    </small>
                  </div>
                </div>
              </div>
              <p class="mb-0">{{ blast.message|linebreaksbr }}</p>
            </article>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-muted mb-0">No updates yet.</p>
          {% endif %}
        </div>
      </section>
    </section>

    <aside
      class="col-lg-5"
      aria-label="Event media and actions"
      role="complementary"
    >
      {% if event.cover_photo_processing_status == 'pending' or event.cover_photo_processing_status == 'processing' %}
      <section
        class="mb-4 d-none d-lg-block"
        aria-labelledby="cover-photo-heading"
      >
        <h2 class="visually-hidden" id="cover-photo-heading">
          Event cover photo
        </h2>
        <div
          class="bg-secondary rounded d-flex align-items-center justify-content-center"
          style="width: 100%; height: 400px"
        >
          <div class="text-center" role="status" aria-live="polite">
            <div class="spinner-border text-white mb-2" role="status">
              <span class="visually-hidden">Processing...</span>
            </div>
          </div>
        </div>
      </section>
      {% elif event.cover_photo_avif_url or event.cover_photo_webp_url or event.cover_photo %}
      <section
        class="mb-4 d-none d-lg-block"
        aria-labelledby="cover-photo-heading"
      >
        <h2 class="visually-hidden" id="cover-photo-heading">
          Event cover photo
        </h2>
        <figure class="mb-0">
          <picture>
            {% if event.cover_photo_avif_url %}
            <source
              srcset="{{ event.cover_photo_avif_url }}"
              type="image/avif"
            />
            {% endif %}
            {% if event.cover_photo_webp_url %}
            <source
              srcset="{{ event.cover_photo_webp_url }}"
              type="image/webp"
            />
            {% endif %}
            {% if event.cover_photo_webp_url %}
            <img
              src="{{ event.cover_photo_webp_url }}"
              class="img-fluid rounded"
              alt="{{ event.title }}"
              style="width: 100%; max-height: 400px; object-fit: cover"
            />
            {% elif event.cover_photo %}
            <img
              src="{{ event.cover_photo.url }}"
              class="img-fluid rounded"
              alt="{{ event.title }}"
              style="width: 100%; max-height: 400px; object-fit: cover"
            />
            {% else %}
            <img
              src="{{ event.cover_photo_avif_url }}"
              class="img-fluid rounded"
              alt="{{ event.title }}"
              style="width: 100%; max-height: 400px; object-fit: cover"
            />
            {% endif %}
          </picture>
          <figcaption class="visually-hidden">
            Cover photo for {{ event.title }}
          </figcaption>
        </figure>
      </section>
      {% endif %}

      <div id="rsvp-desktop-container" class="rsvp-container">
        {% include 'events/partials/rsvp_form.html' with form_id='desktopRsvpForm' wrapper_classes='mb-4 d-none d-lg-block' container_id='rsvp-desktop-container' %}
      </div>
    </aside>
  </article>
</section>

<div id="questionnaire-modal-container">
  {% include 'events/partials/questionnaire_modal.html' %}
</div>

<div
  class="modal fade"
  id="qrCodeModal"
  tabindex="-1"
  aria-labelledby="qrCodeModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="qrCodeModalLabel">{{ event.title }}</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
          title="Close QR code modal"
        ></button>
      </div>
      <div class="modal-body text-center">
        <img id="qrCodeImage" src="" alt="Event QR Code" class="img-fluid" />
      </div>
      <div class="modal-footer">
        <a
          id="qrDownloadLink"
          href="{% url 'event_qr_code' event.id %}"
          download="{{ event.title|slugify }}.png"
          class="btn btn-primary"
        >
          Download
          <i class="fa-solid fa-download"></i>
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  let activeRsvpFormId = null;
  let questionnaireStatus = 'attending';
  const isLoggedIn = {% if user_phone %}true{% else %}false{% endif %};

  function showQRCode() {
      const qrCodeImage = document.getElementById('qrCodeImage');
      qrCodeImage.src = "{% url 'event_qr_code' event.id %}";
      const modal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
      modal.show();
  }

  function copyShortUrl(event) {
      const shortUrl = "{{ event.get_short_url }}";
      const button = event.target.closest('button');
      const originalHTML = button.innerHTML;

      navigator.clipboard.writeText(shortUrl).then(() => {
          button.innerHTML = 'Copied!';
          setTimeout(() => {
              button.innerHTML = originalHTML;
          }, 2000);
      }).catch(err => {
          console.error('Failed to copy:', err);
      });
  }

  function copyPhotoAlbumUrl(event) {
      const photoAlbumUrl = "{{ event.photo_album_url }}";
      const button = event.target.closest('button');
      const originalHTML = button.innerHTML;

      navigator.clipboard.writeText(photoAlbumUrl).then(() => {
          button.innerHTML = 'Copied!';
          setTimeout(() => {
              button.innerHTML = originalHTML;
          }, 2000);
      }).catch(err => {
          console.error('Failed to copy:', err);
      });
  }

  function showQuestionnaireModal(formId, status = 'attending') {
      activeRsvpFormId = formId;
      questionnaireStatus = status;

      if (!isLoggedIn) {
          const fallbackForm = document.querySelector('.js-rsvp-form');
          const targetFormId = formId || (fallbackForm ? fallbackForm.id : null);
          if (!targetFormId) {
              console.error('No RSVP form available for submission');
              return;
          }
          const rsvpForm = document.getElementById(targetFormId);
          if (!rsvpForm) {
              console.error('Unable to locate RSVP form:', targetFormId);
              return;
          }

          const statusInput = document.createElement('input');
          statusInput.type = 'hidden';
          statusInput.name = 'status';
          statusInput.value = status;
          rsvpForm.appendChild(statusInput);

          if (typeof rsvpForm.requestSubmit === 'function') {
              rsvpForm.requestSubmit();
          } else {
              rsvpForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
          }
          return;
      }

      const modalElement = document.getElementById('questionnaireModal');
      if (!modalElement) {
          return;
      }
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
  }

  function submitQuestionnaire() {
      const questionnaireForm = document.getElementById('questionnaireForm');
      if (!questionnaireForm) {
          return;
      }

      if (!questionnaireForm.checkValidity()) {
          questionnaireForm.reportValidity();
          return;
      }

      const fallbackForm = document.querySelector('.js-rsvp-form');
      const targetFormId = activeRsvpFormId || (fallbackForm ? fallbackForm.id : null);
      if (!targetFormId) {
          console.error('No RSVP form available for submission');
          return;
      }
      const rsvpForm = document.getElementById(targetFormId);
      if (!rsvpForm) {
          console.error('Unable to locate RSVP form:', targetFormId);
          return;
      }

      const formData = new FormData(questionnaireForm);
      for (let [key, value] of formData.entries()) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = key;
          input.value = value;
          rsvpForm.appendChild(input);
      }

      const statusInput = document.createElement('input');
      statusInput.type = 'hidden';
      statusInput.name = 'status';
      statusInput.value = questionnaireStatus;
      rsvpForm.appendChild(statusInput);

      if (typeof rsvpForm.requestSubmit === 'function') {
          rsvpForm.requestSubmit();
      } else {
          rsvpForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
      }
  }

  document.body.addEventListener('rsvp-updated', () => {
      const modalElement = document.getElementById('questionnaireModal');
      if (modalElement) {
          const modalInstance = bootstrap.Modal.getInstance(modalElement);
          if (modalInstance) {
              modalInstance.hide();
          }
      }
      activeRsvpFormId = null;
  });

  {% if event.cover_photo_processing_status == 'pending' or event.cover_photo_processing_status == 'processing' %}
  (function pollCoverPhotoStatus() {
      const statusUrl = "{% url 'cover_photo_status' event.id %}";
      let pollInterval;
      let attempts = 0;
      const maxAttempts = 60;

      function checkStatus() {
          attempts++;

          fetch(statusUrl, {
              cache: 'no-cache',
              headers: {
                  'Cache-Control': 'no-cache',
                  'Pragma': 'no-cache'
              }
          })
              .then(response => response.json())
              .then(data => {
                  if (data.status === 'completed' && (data.avif_url || data.webp_url || data.original_url)) {
                      clearInterval(pollInterval);
                      // Force a hard reload to bypass browser cache
                      window.location.href = window.location.href.split('?')[0] + '?t=' + Date.now();
                  } else if (attempts >= maxAttempts) {
                      clearInterval(pollInterval);
                      console.log('Cover photo processing timed out');
                  }
              })
              .catch(error => {
                  console.error('Error checking cover photo status:', error);
                  if (attempts >= maxAttempts) {
                      clearInterval(pollInterval);
                  }
              });
      }

      pollInterval = setInterval(checkStatus, 5000);
      checkStatus();
  })();
  {% endif %}
</script>

{% if pending_questionnaire %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    showQuestionnaireModal(
      null,
      '{{ pending_questionnaire.status|default:"attending"|escapejs }}',
    );
  });
</script>
{% endif %} {% endblock %}
